<!DOCTYPE html>
<html>
<head>
    <title>Config Editor</title>
    <link href="static/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<h4>Streams</h4>

<!-- COLOR STREAM -->
<div class="mb-4">

    <div class="form-check mb-2">
        <input class="form-check-input stream-img-toggle"
               type="checkbox"
               id="colorStreamToggle"
               name="color_frame.stream_enabled"
               data-target="#colorStreamImage"
               {% if cfg.color_frame.stream_enabled %}checked{% endif %}>
        <label class="form-check-label" for="colorStreamToggle">
            Enable Color Stream
        </label>
    </div>

    <div id="colorStreamImage" class="{% if not cfg.color_frame.stream_enabled %}d-none{% endif %}">
        <img src="/streams/video_stream"
             class="img-fluid rounded border"
             alt="Color Stream Preview">
    </div>
</div>

<!-- DEPTH STREAM -->
<div class="mb-4">

    <div class="form-check mb-2">
        <input class="form-check-input stream-img-toggle"
               type="checkbox"
               id="depthStreamToggle"
               name="depth_frame.stream_enabled"
               data-target="#depthStreamImage"
               {% if cfg.depth_frame.stream_enabled %}checked{% endif %}>
        <label class="form-check-label" for="depthStreamToggle">
            Enable Depth Stream
        </label>
    </div>

    <div id="depthStreamImage" class="{% if not cfg.depth_frame.stream_enabled %}d-none{% endif %}">
        <img src="/stream/depth_stream"
             class="img-fluid rounded border"
             alt="Depth Stream Preview">
    </div>
</div>

<hr class="my-4">

<div class="container my-4">
    <h2 class="mb-4">Edit Configuration</h2>

    <form id="configForm" class="card p-4 shadow-sm">

        <h4>Camera</h4>

        <h5 class="mt-3">Filters</h5>

        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="camera.filters.hole_filling.enabled"
                   {% if cfg.camera.filters.hole_filling.enabled %}checked{% endif %}>
            <label class="form-check-label">Hole Filling Enabled</label>
        </div>

        <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" name="camera.filters.spatial.enabled"
                   {% if cfg.camera.filters.spatial.enabled %}checked{% endif %}>
            <label class="form-check-label">Spatial Enabled</label>
        </div>

        <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" name="camera.filters.temporal.enabled"
                   {% if cfg.camera.filters.temporal.enabled %}checked{% endif %}>
            <label class="form-check-label">Temporal Enabled</label>
        </div>

        <div class="mb-3">
            <label class="form-label">FPS</label>
            <input class="form-control" type="number" name="camera.fps"
                   value="{{ cfg.camera.fps }}">
        </div>

        <div class="mb-3">
            <label class="form-label">Resolution</label>
            <select class="form-select" name="camera.resolution">
                {% for res in ["640x480", "1280x720", "848x640"] %}
                    <option value="{{ res }}"
                        {% if cfg.camera.resolution.value == res %}selected{% endif %}>
                        {{ res }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <h4 class="mt-4">Color Frame</h4>
        <div class="mb-3">
            <input class="form-check-input ms-2" type="checkbox"
                   name="color_frame.stream_enabled"
                   {% if cfg.color_frame.stream_enabled %}checked{% endif %}>
            <label class="form-label ms-2">Stream Enabled</label>
        </div>

        <h4 class="mt-4">Depth Frame</h4>
        <div class="mb-3">
            <input class="form-check-input ms-2" type="checkbox"
                   name="depth_frame.stream_enabled"
                   {% if cfg.depth_frame.stream_enabled %}checked{% endif %}>
            <label class="form-label ms-2">Stream Enabled</label>
        </div>

        <div class="mb-3">
            <label class="form-label">Min Confidence</label>
            <input class="form-control" type="number" step="0.01" name="min_confidence"
                   value="{{ cfg.min_confidence }}">
        </div>

        <h4 class="mt-4">Network Tables</h4>

        <div class="mb-3">
            <label class="form-label">Server</label>
            <input class="form-control" type="text" name="network_tables.server"
                   value="{{ cfg.network_tables.server }}">
        </div>

        <div class="mb-3">
            <label class="form-label">Table</label>
            <input class="form-control" type="text" name="network_tables.table"
                   value="{{ cfg.network_tables.table }}">
        </div>

        <h4 class="mt-4">Pipeline</h4>

        <div class="mb-3">
            <label class="form-label">Args</label>
            <input class="form-control" type="text" name="pipeline.args"
                   value="{{ cfg.pipeline.args|join(',') }}">
                <div class="d-flex align-items-center gap-2">
                    <small class="form-text text-muted">Comma seperated list of arguments</small>
                </div>
        </div>

        <div class="mb-3">
            <label class="form-label">Type</label>
            <input class="form-control" type="text" name="pipeline.type"
                   value="{{ cfg.pipeline.type }}">
        </div>

        <div class="mb-3">
            <label class="form-label">RKNN Chip Type</label>
            <input class="form-control" type="text" name="rknn_chip_type"
                   value="{{ cfg.rknn_chip_type }}">
        </div>

        <button class="btn btn-primary" type="button" onclick="submitFormJson()">Save</button>

    </form>
</div>

<script>
function setDeep(obj, path, value) {
    const parts = path.split(".");
    let cur = obj;
    for (let i = 0; i < parts.length - 1; i++) {
        if (!(parts[i] in cur)) cur[parts[i]] = {};
        cur = cur[parts[i]];
    }
    cur[parts[parts.length - 1]] = value;
}

function submitFormJson() {
    const form = document.getElementById("configForm");
    const data = {};

    for (const el of form.elements) {
        if (!el.name) continue;

        let value;
        if (el.type === "checkbox") {
            value = el.checked;
        } else {
            value = el.value;
        }
        setDeep(data, el.name, value);
    }

    fetch("/update_config", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(data)
    });
}
</script>

</body>
</html>
